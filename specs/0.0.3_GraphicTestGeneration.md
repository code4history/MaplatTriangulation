# @maplat/triangulation 0.0.3 

## 0.0.3で実装する機能

### 開発項目1. テストデータ生成UIの作成 

- 0.0.2でテストデータ作成スクリプト (scripts/generatedTestData.ts)を作成したが、スクリプトでの生成は、わざとエラーを発生させたりの編集が困難であるため、自動生成しつつ、手動で修正するWeb UIを開発する
- npm script または index.html のVS code Live Server 起動などで動作 (どちらでもよい)
- Web UIを起動すると、以下の要素が表示される
  - 点群と三角網を表示する、横並びのCanvas領域2つ（2つの座標平面に相当する）
    - 左側 (平面A) は、XY座標とも座標範囲 0～10000
    - 右側 (平面B) は、拡縮、平行移動を伴うアフィン変換の結果、座標範囲が異なるので、全座標点で適切に正方形範囲の座標範囲を正規化して、表示範囲を決定。原点は0,0である必要はない (完全に、座標系の存在範囲内に余白数%マージンの範囲で表示すればよい)
  - 点の数、アフィン変換の定数など、様々な値を手動修正するための、form/inputタグの領域
  - 点群をtests/points/testData.jsonのデータ形式で出力するTextArea
    点群の編集が行われればリアルタイムでTextAreaへの修正がかかるほか、入力も受け付け、直接ユーザがTextAreaを書き換えればCanvasの中身がその情報に変わる (平面Bは座標系範囲が変わる可能性があるのに注意)
- 起動時に、scripts/generatedTestData.tsと同様に、サンプルの座標セットを生成し、その点群をCanvasに表示、そして点の数、アフィン定数群など初期値としてinputフォームに表示。
  - その後、右側も左側も、表示された点群に対して、マウスで点をクリックすると:
    - クリックされた点と、それと対応するもう一方の平面の対応点が、色が変わり選択状態になる
    - 選択状態は、余白をクリックするか、他の点を選択することで解除される
    - 選択状態の点は、ドラッグで場所を変更でき、変更するたびにTextAreaのデータも更新
  - また、フォーム内にある三角網表示のオンオフのトグルボタンを押すと、平面A側で生成した三角網を両平面に適用した結果が表示される
    - 点の移動状況によっては、平面B側でトポロジーエラーが発生するが、その辺の交点には、頂点とは違う色でエラーの発生がわかりやすいように表示
    - 三角網表示中は、クリックによる対応点の表示、ドラッグによる点の移動はできなくなる
    - 代わりに、辺のクリックによる対応線が強調される他、辺をダブルクリックすると、その辺を共有する三角の間で、辺の繋ぎ変えを発生させられる。ただし、当然ながら三角網の凸包の輪郭線上の辺は繋ぎ変えができないため、繋ぎ変え機能は動作せず、対応線強調機能まで
    - 繋ぎ変えた三角網は、覚えておく必要はない。一旦三角網を消去して、再表示した際は再度三角網生成した結果を表示すればよい
    - 三角網表示中は、TextArea内の表示も、三角網情報を含めたものを表示する。三角網表示を消すと、TextAreaも対応点の情報のみとなる

## 開発結果のまとめ

### 追加した機能

1. **ビジュアルデータ生成・編集UI**：
   - 2つの平面（平面AとB）を横並びに表示するキャンバスを実装
   - アフィン変換パラメータの調整機能（拡縮、せん断、回転、平行移動、Y軸反転）
   - ノイズレベルの調整機能（ガウス分布ノイズ）

2. **インタラクティブな点の編集機能**：
   - クリックによる点の選択
   - ドラッグによる点の移動
   - リアルタイムでの座標更新と表示

3. **三角網とトポロジーエラーの可視化**：
   - ドロネー三角形分割の可視化
   - トポロジーエラー（交差する辺）の強調表示
   - エラー表示のオン/オフ切り替え

4. **データのインポート/エクスポート機能**：
   - 生成したデータをJSON形式で表示
   - JSON形式のデータをテキストエリアに直接入力可能
   - データのコピーとファイル保存機能
   - 外部ファイルからのデータ読み込み機能

### 実装の詳細

1. **HTML/CSSの構成**：
   - レスポンシブデザインのUIレイアウト
   - コントロールパネルとキャンバス領域の分離
   - 直感的に使えるフォーム要素

2. **TypeScriptによる実装**：
   - 型安全なコーディング
   - モジュール化された機能（点の生成、座標変換、描画処理など）
   - イベント駆動型のインタラクション処理

3. **座標変換システム**：
   - 平面A（0〜10000の座標系）とキャンバス座標間の変換
   - 平面B（変換後の座標系）とキャンバス座標間の変換
   - 両平面での一貫した点の表示と操作

4. **三角網生成と検証**：
   - 既存の`generateTriangulation`関数を使用した三角網生成
   - `detectTopologyErrors`関数によるエラー検出
   - 交差点の計算と可視化

### 開発上の工夫点

1. **パフォーマンス最適化**：
   - キャンバスのリサイズ時の適切なスケーリング
   - デバイスピクセル比（DPR）を考慮した高解像度描画
   - 効率的なドローイングアルゴリズム

2. **ユーザビリティ向上**：
   - 直感的な点の選択と編集操作
   - リアルタイムでのデータ更新とフィードバック
   - アクセシブルなUIコントロール

3. **デバッグ支援**：
   - JSONデータのエクスポート/インポート機能
   - トポロジーエラーの明示的な可視化
   - 開発者向けのコンソールメッセージ

### 使用方法

1. 開発サーバーの起動：
   ```bash
   npm run start:visualizer
   ```
   または
   ```bash
   npm run dev
   ```

2. 基本操作：
   - 「データ生成」ボタンで新しいランダム点群を生成
   - アフィン変換パラメータを調整して「変換を適用」をクリック
   - キャンバス上で点をクリック＆ドラッグして位置を調整
   - 「三角網表示」チェックボックスでドロネー三角形分割を表示/非表示
   - 「エラー表示」チェックボックスでトポロジーエラーの表示/非表示を切り替え

3. データ操作：
   - 「コピー」ボタンでJSONデータをクリップボードにコピー
   - 「保存」ボタンでJSONファイルとして保存
   - 「読み込み」ボタンで保存したJSONファイルをロード
   - テキストエリアに直接JSONを貼り付けることも可能

### 残存課題および今後の改善点

1. **ユーザビリティの向上**：
   - より直感的な三角網の繋ぎ変え操作の実装
   - 補助点の追加機能の実装
   - 三角網表示時の拡大・縮小機能

2. **機能拡張**：
   - 必須辺制約や禁止辺制約の追加と編集機能
   - トポロジーエラー解消アルゴリズムの視覚的デモンストレーション

3. **UIの改善**：
   - モバイル端末対応の強化
   - キーボードショートカットの追加
   - ダークモード対応

4. **テストケース保存機能**：
   - 特定のトポロジーエラーパターンのライブラリ化
   - テストケースのカテゴリ分けと管理機能
