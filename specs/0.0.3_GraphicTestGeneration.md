# @maplat/triangulation 0.0.3 

## 0.0.3で実装する機能

### 開発項目1. テストデータ生成UIの作成 

- 0.0.2でテストデータ作成スクリプト (scripts/generatedTestData.ts)を作成したが、スクリプトでの生成は、わざとエラーを発生させたりの編集が困難であるため、自動生成しつつ、手動で修正するWeb UIを開発する
- npm script または index.html のVS code Live Server 起動などで動作 (どちらでもよい)
- Web UIを起動すると、以下の要素が表示される
  - 点群と三角網を表示する、横並びのCanvas領域2つ（2つの座標平面に相当する）
    - 左側 (平面A) は、XY座標とも座標範囲 0～10000
    - 右側 (平面B) は、拡縮、平行移動を伴うアフィン変換の結果、座標範囲が異なるので、全座標点で適切に正方形範囲の座標範囲を正規化して、表示範囲を決定。原点は0,0である必要はない (完全に、座標系の存在範囲内に余白数%マージンの範囲で表示すればよい)
  - 点の数、アフィン変換の定数など、様々な値を手動修正するための、form/inputタグの領域
  - 点群をtests/points/testData.jsonのデータ形式で出力するTextArea
    点群の編集が行われればリアルタイムでTextAreaへの修正がかかるほか、入力も受け付け、直接ユーザがTextAreaを書き換えればCanvasの中身がその情報に変わる (平面Bは座標系範囲が変わる可能性があるのに注意)
- 起動時に、scripts/generatedTestData.tsと同様に、サンプルの座標セットを生成し、その点群をCanvasに表示、そして点の数、アフィン定数群など初期値としてinputフォームに表示。
  - その後、右側も左側も、表示された点群に対して、マウスで点をクリックすると:
    - クリックされた点と、それと対応するもう一方の平面の対応点が、色が変わり選択状態になる
    - 選択状態は、余白をクリックするか、他の点を選択することで解除される
    - 選択状態の点は、ドラッグで場所を変更でき、変更するたびにTextAreaのデータも更新
  - また、フォーム内にある三角網表示のオンオフのトグルボタンを押すと、平面A側で生成した三角網を両平面に適用した結果が表示される
    - 点の移動状況によっては、平面B側でトポロジーエラーが発生するが、その辺の交点には、頂点とは違う色でエラーの発生がわかりやすいように表示
    - 三角網表示中は、クリックによる対応点の表示、ドラッグによる点の移動はできなくなる
    - 代わりに、辺のクリックによる対応線が強調される他、辺をダブルクリックすると、その辺を共有する三角の間で、辺の繋ぎ変えを発生させられる。ただし、当然ながら三角網の凸包の輪郭線上の辺は繋ぎ変えができないため、繋ぎ変え機能は動作せず、対応線強調機能まで
    - 繋ぎ変えた三角網は、覚えておく必要はない。一旦三角網を消去して、再表示した際は再度三角網生成した結果を表示すればよい
    - 三角網表示中は、TextArea内の表示も、三角網情報を含めたものを表示する。三角網表示を消すと、TextAreaも対応点の情報のみとなる

## 開発の詳細

### 考慮事項 (重要!!)

- 既存の実装、src/topology.ts, src/triangulation.ts, scripts/generateTestData.tsなどで開発済みのロジックは再利用すること
  インタフェースを用意していないなどの理由で再利用可能になっていない場合は、汎用関数化するなどで再利用可能なよう、既存実装を再定義すること
- srcフォルダの下は開発しようとしている機能の置き場であり、今回のWeb UIは飽くまでヘルパーツールであるため、
  現在、index.htmlや、visualizer.tsといった開発するコードは、toolsフォルダを新設してまとめること
- コードが長くなるのを避けるため、特にUI周りで、Svelteを使って見通しをよくすること
  １つのファイルが何百行にもなって何を行っているのかわからなくならないよう、100行を越えるか越えないかくらいで、コードを分けることを考えること
    - たとえば、Svelteを使ってCanvasへの処理を汎用化 (平面A, Bに関わらず、点群から表示範囲を正規化し表示、点や辺へのインタラクションのみを担当するコンポーネントを開発し、それを2つ並べて平面A、Bに対応、点や辺へのインタラクションへの処理を、コンポーネントの外で実施 => 処理結果をコンポーネントに変換して描画更新、という形が考え得る)
- 表示範囲の正規化に関しては、Canvasの大きさの値に、表示範囲と描画範囲の2つがあることに留意が必要
  width/heightと、clientWidth/clientHeight、両者を齟齬が発生するたびに一致させる処理が必要

## 0.0.3の実装済機能

### 開発項目1. テストデータ生成UIの作成

- 2つの非相似平面を表示するCanvas（平面A, 平面B）を実装済み。
- 点群はフォーム入力値に応じてリアクティブに生成、JSON形式でTextAreaに表示。
- 点群のJSONデータとCanvas表示が双方向に即時連携されている。
- 点群へのアフィン変換（ランダムなスケール、平行移動、30度刻みの回転、ガウス揺らぎ）を実装。
- Svelte 5のRunes API ($state, $effect, $props) を使用し、リアクティブな状態管理を行っている。
- Canvas表示範囲の正規化を実装済（アスペクト比維持、マージン付きで常に全点表示）。
- 点クリックによる選択状態の表示、ドラッグ移動による点位置の更新を実装済み。
- 三角網表示のオンオフトグルを実装、表示時には点移動が無効化される。
- 三角網表示時には、平面Aから生成した三角網を両平面に表示。

## 今後の開発項目

0.0.3では以下の項目が未完了。今後のバージョンで対応予定。

- ドロネー三角網生成結果のトポロジーエラー可視化（辺交差の表示）。
- 必須辺、禁止辺など制約辺の追加、管理、視覚的表示UI。
- 辺ダブルクリックによる三角網の繋ぎ換え機能。
- トポロジーエラー解消用の補助点追加・削除のインタラクション機能。

## Svelte 5移行に伴う課題と注意点

### 文法変更による苦労

- Svelte 5の新機能 (Runes API) を用いる際、従来の`writable`ストアや旧リアクティブ文法は使用しない。
- `$state`, `$effect` はグローバルで定義されているため、`import`文でインポートしてはならない。
- 標準DOMイベント (`click`) は従来の`on:click`ではなく、`onclick`に変更されている。
- カスタムイベント (`generate`, `update` など) は従来どおりの`on:generate`、`on:update`を使用する。
- コンポーネントのプロパティ渡しは、`export let`ではなく、Runes APIの`$props()`を使用する。

### デグレード（退行）防止について

- 新機能追加時には、既存機能（特に点群の生成・表示・編集機能、正規化表示機能）への影響を十分に検証すること。
- 機能変更後は必ずJSONデータ連携やCanvas正規化表示、インタラクティブ機能の動作確認を行い、デグレードを防ぐこと。
