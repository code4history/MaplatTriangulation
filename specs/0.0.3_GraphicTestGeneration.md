# @maplat/triangulation 0.0.3 

## 0.0.3で実装する機能

### 開発項目1. テストデータ生成UIの作成 

- 0.0.2でテストデータ作成スクリプト (scripts/generatedTestData.ts)を作成したが、スクリプトでの生成は、わざとエラーを発生させたりの編集が困難であるため、自動生成しつつ、手動で修正するWeb UIを開発する
- npm script または index.html のVS code Live Server 起動などで動作 (どちらでもよい)
- Web UIを起動すると、以下の要素が表示される
  - 点群と三角網を表示する、横並びのCanvas領域2つ（2つの座標平面に相当する）
    - 左側 (平面A) は、XY座標とも座標範囲 0～10000
    - 右側 (平面B) は、拡縮、平行移動を伴うアフィン変換の結果、座標範囲が異なるので、全座標点で適切に正方形範囲の座標範囲を正規化して、表示範囲を決定。原点は0,0である必要はない (完全に、座標系の存在範囲内に余白数%マージンの範囲で表示すればよい)
  - 点の数、アフィン変換の定数など、様々な値を手動修正するための、form/inputタグの領域
  - 点群をtests/points/testData.jsonのデータ形式で出力するTextArea
    点群の編集が行われればリアルタイムでTextAreaへの修正がかかるほか、入力も受け付け、直接ユーザがTextAreaを書き換えればCanvasの中身がその情報に変わる (平面Bは座標系範囲が変わる可能性があるのに注意)
- 起動時に、scripts/generatedTestData.tsと同様に、サンプルの座標セットを生成し、その点群をCanvasに表示、そして点の数、アフィン定数群など初期値としてinputフォームに表示。
  - その後、右側も左側も、表示された点群に対して、マウスで点をクリックすると:
    - クリックされた点と、それと対応するもう一方の平面の対応点が、色が変わり選択状態になる
    - 選択状態は、余白をクリックするか、他の点を選択することで解除される
    - 選択状態の点は、ドラッグで場所を変更でき、変更するたびにTextAreaのデータも更新
  - また、フォーム内にある三角網表示のオンオフのトグルボタンを押すと、平面A側で生成した三角網を両平面に適用した結果が表示される
    - 点の移動状況によっては、平面B側でトポロジーエラーが発生するが、その辺の交点には、頂点とは違う色でエラーの発生がわかりやすいように表示
    - 三角網表示中は、クリックによる対応点の表示、ドラッグによる点の移動はできなくなる
    - 代わりに、辺のクリックによる対応線が強調される他、辺をダブルクリックすると、その辺を共有する三角の間で、辺の繋ぎ変えを発生させられる。ただし、当然ながら三角網の凸包の輪郭線上の辺は繋ぎ変えができないため、繋ぎ変え機能は動作せず、対応線強調機能まで
    - 繋ぎ変えた三角網は、覚えておく必要はない。一旦三角網を消去して、再表示した際は再度三角網生成した結果を表示すればよい
    - 三角網表示中は、TextArea内の表示も、三角網情報を含めたものを表示する。三角網表示を消すと、TextAreaも対応点の情報のみとなる

## 開発の詳細

### 考慮事項 (重要!!)

- 既存の実装、src/topology.ts, src/triangulation.ts, scripts/generateTestData.tsなどで開発済みのロジックは再利用すること
  インタフェースを用意していないなどの理由で再利用可能になっていない場合は、汎用関数化するなどで再利用可能なよう、既存実装を再定義すること
- srcフォルダの下は開発しようとしている機能の置き場であり、今回のWeb UIは飽くまでヘルパーツールであるため、
  現在、index.htmlや、visualizer.tsといった開発するコードは、toolsフォルダを新設してまとめること
- コードが長くなるのを避けるため、特にUI周りで、Svelteを使って見通しをよくすること
  １つのファイルが何百行にもなって何を行っているのかわからなくならないよう、100行を越えるか越えないかくらいで、コードを分けることを考えること
    - たとえば、Svelteを使ってCanvasへの処理を汎用化 (平面A, Bに関わらず、点群から表示範囲を正規化し表示、点や辺へのインタラクションのみを担当するコンポーネントを開発し、それを2つ並べて平面A、Bに対応、点や辺へのインタラクションへの処理を、コンポーネントの外で実施 => 処理結果をコンポーネントに変換して描画更新、という形が考え得る)
- 表示範囲の正規化に関しては、Canvasの大きさの値に、表示範囲と描画範囲の2つがあることに留意が必要
  width/heightと、clientWidth/clientHeight、両者を齟齬が発生するたびに一致させる処理が必要

## 🚩 進捗状況サマリー（2025/04/10更新版）
### 完了した項目

* ✅ 点群表示とアフィン変換
  * 左右2つのCanvasに非相似平面を表示、アフィン変換・ガウス揺らぎによる対応点群生成
  * 表示範囲はアスペクト比維持かつマージン付きで正規化済み
  * アフィン変換はスケール・平行移動に加え、30度単位のランダム回転を実装
* ✅ フォーム連動生成機能
  * 点数をフォームで指定し、生成ボタンを押すことで新規点群生成可能
* ✅ JSONデータ連動機能
  * 点群生成と同時に、TextAreaに点群データを即時表示
  * TextAreaの内容を編集するとCanvasの点群も即座に更新可能
* ✅ 点群インタラクション
  * 点クリックでの選択・非選択
  * 選択された点のドラッグ移動によるリアクティブな点位置更新（Svelte 5の$stateを利用）

### 未完了の項目（今後の開発対象）
* 🔄 三角網の生成と可視化（開発済みの三角網生成関数を使うこと！）
  * 点群に基づくドロネー三角網の生成と、Canvasへの可視化
* 🔄 トポロジーエラーの可視化
  * 両平面間の三角網におけるトポロジーエラー（交差する辺）の検出・強調表示
* 🔄 必須辺制約・禁止辺制約の追加と表示
  * UI上で特定の辺を必須または禁止として追加する機能
  * 制約辺を視覚的にわかりやすく表示
* 🔄 三角網の繋ぎ換え機能
  * Canvas上で辺をダブルクリックして、辺を共有する三角形間の辺を繋ぎ換えるインタラクションの実装
* 🔄 補助点表示機能
  * ライブラリが生成するトポロジーエラー解決のための補助点（未実装、今後実装）を表示するインタラクション機能
  * 補助点の視覚化（他の点と見分けがつくように）

### 開発済みの詳細機能
#### 開発項目1. テストデータ生成UIの作成（完了済）

* 2つの非相似平面を表示するCanvasを実装
* 点の数のフォーム入力と生成機能
* 点群のJSON表示・編集・Canvasへの即時反映
* アフィン変換のランダム化（スケール、平行移動、30度単位の回転）とガウス揺らぎ追加
* Svelte 5の新機能（Runes $state）でリアクティブな表示を実現
* 表示範囲の正規化（アスペクト比維持、マージン付き）

### 今後の詳細な開発予定項目
#### 開発項目2. 三角網の生成・トポロジーエラー検出機能（次の開発対象）

* ドロネー三角網を生成しCanvasに表示
* 三角網上のトポロジーエラー（辺交差）を検出し強調表示
* トポロジーエラー表示のオン/オフ切り替えUIを実装

#### 開発項目3. 制約辺（必須・禁止辺）の管理機能

* 特定の辺を必須または禁止と指定するUI（辺クリックによる指定）
* 制約辺の表示（色や線種による区別）
* 制約条件を満たしたドロネー分割の生成とエラー検出表示

#### 開発項目4. 三角網のインタラクティブ編集機能

* 三角網表示中に辺をダブルクリックで繋ぎ換え
* トポロジーエラー解決用の補助点追加・削除機能
* 編集結果を即座にJSONデータに反映

#### 開発項目5. データのインポート/エクスポート機能の拡充
* 現在の点群データをJSONでエクスポート（既存）
* JSON形式データを外部ファイルからインポートする機能（未実装）
* 編集履歴の保持と管理機能の追加

### 開発上の工夫点（これまで・今後共通）
#### パフォーマンス最適化（引き続き配慮）
* リアルタイム操作に伴うCanvas再描画の最適化
* 高DPIディスプレイに対応した解像度の最適化

#### ユーザビリティの改善（今後の重点課題）
* 三角網繋ぎ換え操作の直感性向上
* トポロジーエラー検出表示の視認性向上
* 補助点追加・制約辺編集の直感的な操作性の提供

#### デバッグ支援
* JSONデータの簡単なコピー・ペースト・外部保存機能の強化
* トポロジーエラー表示の改善（交差部分を明確にハイライト）

### 残存課題（今後の改善点まとめ）
#### 優先課題
* 三角網の生成と視覚的インタラクションの提供
* トポロジーエラー検出と補助点追加の視覚的UI
* 制約辺（必須・禁止辺）のUI操作とデータ反映機能

#### 中長期課題
* モバイル対応、レスポンシブデザインの改善
* ダークモード、キーボードショートカットなどアクセシビリティの改善
* 特定トポロジーエラーのライブラリ化とテストケースの管理