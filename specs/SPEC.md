# Maplat用三角網ロジック開発仕様

## 開発すべき機能

* 2つのデカルト平面があり、それらは相似関係にない（平面投影した現実世界と、その手書き絵地図や古地図などとの平面対応関係を想定）
* 両平面間に以下の対応する地物あるいは制約が定義される
  A. 両平面間での対応する点のセット (3点以上定義必須、各点はインデックスを持つ)
  B. 両平面間での対応する辺のセット (2点のインデックスで、その間を結ぶ辺を示す、必須ではない、定義された場合、それらの辺は必ず生成された三角網の構成辺となる制約を持つ)
  C. 両平面間での、選ばれてはいけない辺のセット (2点のインデックスで、その間を結ぶ辺を示す、必須ではない、定義された場合、それらの辺は必ず生成された三角網の構成辺と「なってはいけない」制約を持つ)

* 機能を実行すると、A.で定義された全点を含む三角網を定義する(三角網を成立させる、2点のインデックスで、その間を結ぶ辺のセットを作成する)

* その際、以下の制約を実現すること
  * 両平面で、同相の三角網を定義する(両座標系で、同じ辺セットを三角網定義に用いる)
  * 両平面で、トポロジーエラーを発生させないようにする、発生している場合は繋ぎ変え、補助点追加などの手法でトポロジーエラーを解消する
  * Bが定義されている場合、三角網を定義する辺セットは、必ずBで定義された辺セットをすべて含まなければならない(含まれている場合は、繋ぎ変え、補助点追加などの手法で解消する)
  * Cが定義されている場合、三角網を定義する辺セットには、必ずCで定義された辺セットが一切含まれてはならない(含まれている場合は、繋ぎ変え、補助点追加などの手法で解消する)

* エラーの解決に利用できそうな手法
  * 以下に挙げる手法は、「それを使わなければいけない」という物ではなく、「解決に使えそうな手法として現状候補に挙がっているもの」、あるいは補助点の追加のように「許されている手法」を列挙している
    A. 辺を共有し折り返したようになる2つの三角形、あるいは辺が交差する複数の三角形の間での、点の繋ぎ直し
    B. 双方の平面で三角網生成を行い、トポロジーエラーを生じた点群においては、その点群の間でもう一方の平面での三角網の生成結果を採用する。ただし、これは結果的にA.と等価な結果になる可能性がある
    C. どうしてもトポロジーエラーが解消しない場合においては、トポロジーエラーとならない場所に、必要最小限の補助対応点を両平面で自動生成し、補助対応点を交えた三角網を生成する。ただし、補助対応点は人間が与えた当初の対応点と分けて管理される必要がある。
  * 生成AIは、上記に挙げたような手法以外にも、トポロジーエラーを解消でき、かつ十分に高速なアルゴリズムを導入できるが、どのようなアルゴリズムを導入したか、またどのような補助制約(補助対応点のようなもの、たとえば補助辺制約など)を加えたかを、人間に説明できる必要がある

* トポロジーエラー、あるいはB.、C.の制約エラーが論理的に解消できない場合は、それを検出する
  * 論理的に解消できないエラーとは、例えばある点が、その点を除いた残り全点の凸苞の、一方の座標系では内部、もう一方の座標系では外部にあるような場合である
  * そのような論理的に解消できないエラーは、上記条件以外にも、もっと局地的に発生するものなど様々な条件がありうると考えられるが、それを検出し、エラーの理由と解消方法(特定のどの対応点を除く、など)を利用者に示す

## 開発成果物条件

* 開発するロジックは、TypeScript、vite、vitest
* 基本となる三角網生成ロジックはMapboxのDelaunatorを導入

## 開発手順条件

* 開発成果物を得るまでの方針などについて以下の手順に則ること
  1. 最終成果物は、上記のような二平面に散らばった対応点セットと必須辺制約、禁止辺制約を元に、トポロジーエラーや制約エラーを生じない三角網を生成し、処理の出力として
    * 与えられた対応点、必須辺制約、禁止辺制約 (初期値)
    * 処理中に生成した補助データ (補助対応点など)
    * 三角網生成に成功した場合、最終的な三角網データ(辺セット及び三角系の頂点インデックスセット)
    * 三角形生成に失敗した場合、生成できない原因 (論理的にトポロジーエラーを解消できない、制約辺が交差する、未知のエラーなど)
    を得る、TypeScript関数を生成
  2. 最終的に上記を実現するが、開発はステップバイステップで行うこと (例: まず開発環境を作成する、テスト環境を作成する、辺制約を実現する、トポロジーエラーを解消する、etc.)
     ステップバイステップのイテレーションを回して、完成に近づけること
  3. ステップバイステップの開発の段階毎に、500対応点程度のテストデータを、両平面上の点をほぼ同相に近い配置にしつつ、座標へのゆらぎ要素を加えて作成し、テストを行うこと
     その時点での開発トピックに応じて、意図的にエッジケースのテストデータを作る(例: トポロジーエラー解消ロジック検討中は、意図的に解消可能なトポロジーエラーを発生させるなど)事も検討すること
  4. 意図に反して失敗したテストデータ(開発中のロジックにバグがあったなどの理由で)については、その後のデバグで改善したことを確認するために、テストデータを残しておくこと
     運よくエラーが発生せずに完成した機能についても、デグレを発生させない確認用に、「開発項目ごとに10件」程度のテストケースを残しておくこと
     新しい機能を開発するごとに、その確認のために作成した新しいテストケースに加えて、デグレが発生していないかを確認するために、過去のテストケースも全て通ることを確認すること
  5. そのイテレーションでの開発事項の成功、失敗に関わらず、次のイテレーションで何を開発するか、どのような手法を試みるかは、人間に相談、確認して決定すること
     また、その時点でのソースコード、テストケース、次のイテレーションでの開発前の状態説明と開発する目標機能、また本仕様書の内容として更新すべき事がある場合は仕様の更新内容まで、1から生成AIに新しいスレッドとしてソースコードやドキュメント、仕様書を与えてもイテレーションを継続できるよう、コンテキストを出力すること

以上のような条件に従って、仕様にのっとった機能を作成するための開発イテレーションを、人間に逐次状況を伝え判断を仰ぎつつ回して、必要に応じて本仕様書も更新しつつ、慎重に三角網生成ロジックをTypeScriptで実装すること